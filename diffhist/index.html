<!doctype html>
<html>
  <head>
    <title>Tools - Diff Hist</title>
    <link rel="icon" type="image/png" href="../favicon.png">
    <script src="../pendo.js"></script>
    <link rel="stylesheet" href="https://benjamine.github.io/jsondiffpatch/style.css" type="text/css" />
    <link
      rel="stylesheet"
      href="https://esm.sh/jsondiffpatch@0.6.0/lib/formatters/styles/html.css"
      type="text/css"
    />
    <link
      rel="stylesheet"
      href="https://esm.sh/jsondiffpatch@0.6.0/lib/formatters/styles/annotated.css"
      type="text/css"
    />
    <script type="module">
        import * as jsondiffpatch from 'https://esm.sh/jsondiffpatch@0.6.0';
        import * as annotatedFormatter from 'https://esm.sh/jsondiffpatch@0.6.0/formatters/annotated';
        import * as htmlFormatter from 'https://esm.sh/jsondiffpatch@0.6.0/formatters/html';

        function generateDelta(left, right) {
          const delta = jsondiffpatch.diff(left, right);
          // beautiful html diff
          document.getElementById('visual').innerHTML = htmlFormatter.format(delta, left);
          // self-explained json
          document.getElementById('annotated').innerHTML = annotatedFormatter.format(delta, left);
        }

        window.reversed = false

        var prev = null
        window.generate = function(a, b) {
            if (prev != null) {
                document.getElementById('button'+prev).style.background = ""
            }
            if (window.reversed) {
              generateDelta(json[json.length - a - 1], json[json.length - b - 1])
            } else {
              generateDelta(json[a], json[b])
            }
            document.getElementById('button'+a).style.background = "yellow"
            prev = a
        }
    </script>
  </head>
  <body>
    <script>
        function buildDiffer(json) {
            document.getElementById('setup').style.display = 'none'

            var buttons = ''

            for (let i = 0; i < json.length - 1; i++) {
                buttons += '<input type="button" value="' + (i + 1) + ' -> ' + (i + 2) + '" '
                buttons += 'id="button' + i + '" '
                buttons += 'onclick=generate('+ i + ',' + (i + 1) + ') />'
            }

            document.getElementById('buttons').innerHTML = buttons

            window.json = json

            generate(0, 1)

            document.getElementById('differ').style.display = 'block'
        }

        function onUpload(file) {
            var fr = new FileReader()
            fr.onload = function(e) {
                const result = JSON.parse(e.target.result)
                buildDiffer(result)
            }
            fr.readAsText(file.files[0])
        }

        function onPaste() {
          buildDiffer(JSON.parse(document.getElementById('input').value))
        }

        function onReverse(e) {
          window.reversed = e.checked
          generate(0, 1)
        }

        function onBack() {
          document.getElementById('file').value = ''
          document.getElementById('input').value = ''
          document.getElementById('differ').style.display = 'none'
          document.getElementById('setup').style.display = 'block'
        }
    </script>
    <div id="setup">
      <div style="text-align: center;">
        <h3 style="display: inline;">Paste or</h3>
        <input id="file" name="file" type="file" onchange="onUpload(this)" />
      </div>
      <div style="height: 90%; width: 90%; text-align: center; position: fixed">
        <textarea id="input" style="width: 80%; height: 90%; margin-top: 15px;" oninput="onPaste()"></textarea>
      </div>
    </div>

    <div id="differ" style="display: none;">
      <div id="header" style="position: fixed; width: 100%; background-color: gray; top: 0; padding: 10px; left: 0;">
        <div id="buttons"></div>
        <div style="margin-top: 5px;">
        <input type="checkbox" id="reverseCheckbox" name="reverseCheckbox" value="reverse" onclick="onReverse(this)" />
        <label for="reverseCheckbox">Reverse Array</label>
        <input type="button" value="back" style="margin-left: 15px;" onclick="onBack()" />
        </div>
      </div>
        <div id="visual" style="padding-top: 75px"></div>
        <hr />
        <div id="annotated"></div>
    </div>
  </body>
</html>